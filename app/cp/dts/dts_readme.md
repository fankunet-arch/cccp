# DTS (Date Timeline System) 使用文档

## 项目简介

**DTS (Date Timeline System)** 是一个基于现有 CP 系统的日期时间线管理子模块，用于管理各种证件、车辆、健康等对象的时间节点和提醒。

### 核心功能

- **主体管理**：管理个人、公司等主体
- **对象管理**：管理证件、车辆、健康等具体对象
- **事件记录**：记录对象的时间线事件
- **规则模板**：自动计算时间节点（到期日、窗口期、周期日等）
- **智能提醒**：总览页面显示所有即将到来的重要节点

---

## 快速开始

### 1. 数据库安装

运行 SQL 文件创建数据库表：

```bash
mysql -u your_user -p your_database < /path/to/app/cp/dts/dts_schema.sql
```

或在 MySQL 客户端中导入：

```sql
SOURCE /path/to/app/cp/dts/dts_schema.sql;
```

### 2. 访问系统

登录 CP 系统后，在侧边栏菜单中找到 **"日期管理"** 部分，点击 **"DTS 时间线"**。

---

## 核心概念

### 主体（Subject）

代表"谁"的事情，可以是：
- 个人（如 A1、B2）
- 公司（如 A1公司、B2公司）
- 其他实体

### 对象（Object）

代表被管理的具体对象，例如：
- 证件：中国护照、西班牙护照、NIE、驾照等
- 车辆：车辆本体、轮胎、刹车片等部件
- 健康：体检、洗牙、疫苗等
- 家庭：房屋合同、水电网等
- 店铺：营业执照、食品许可等

### 事件（Event）

对象时间线上发生的具体事情，如：
- 递交材料
- 签发/获批
- 续期
- 保养
- 更换部件
- 跟进检查

### 规则模板（Rule）

定义如何根据事件计算时间节点：

1. **证件类规则（expiry_based）**
   - 基准：过期日
   - 计算：最早可办日、建议办理日、最晚安全日、截止日

2. **周期类规则（last_done_based）**
   - 基准：上次完成日
   - 计算：下一次周期日（如保养、体检）

3. **跟进类规则（submit_based）**
   - 基准：递交日
   - 计算：跟进日（如递交后 3 个月检查结果）

---

## 使用流程示例

### 场景一：管理中国护照

1. **创建主体**
   - 进入"主体管理"
   - 点击"新增主体"
   - 填写：名称"A1"，类型"个人"
   - 保存

2. **创建对象**
   - 进入"对象管理"
   - 点击"新增对象"
   - 填写：
     - 所属主体：A1
     - 对象名称：A1 中国护照
     - 大类：证件
     - 小类：护照
     - 标识：护照号（可选）
   - 保存

3. **记录签发事件**
   - 进入对象详情页（点击对象的"详情"按钮）
   - 点击"新增事件"
   - 填写：
     - 事件类型：签发/获批
     - 事件日期：签发日期
     - 新过期日：护照过期日期
     - 使用规则：中国护照_换发规则_v1
   - 保存

4. **查看提醒**
   - 进入"DTS 总览"
   - 系统将自动显示：
     - 最早可办日（过期日前 180 天）
     - 建议办理日（过期日前 90 天）
     - 最晚安全日（过期日前 30 天）
     - 截止日（过期日）

### 场景二：管理车辆保养

1. **创建对象**
   - 对象名称：A1 的车辆 Q3
   - 大类：车辆
   - 小类：整车保养

2. **记录保养事件**
   - 事件类型：保养
   - 事件日期：保养日期
   - 当前里程：70000（公里）
   - 使用规则：车辆整车保养_年度规则_v1

3. **系统自动计算**
   - 下次保养日期：保养日期 + 12 个月

### 场景三：NIE 递交跟进

1. **记录递交事件**
   - 事件类型：递交材料
   - 事件日期：递交日期
   - 使用规则：NIE_递交跟进规则_v1

2. **系统生成跟进节点**
   - 跟进日期：递交日期 + 3 个月
   - 在 DTS 总览中显示提醒

3. **跟进后续**
   - 到达跟进日期后，记录新事件：
     - 如已通过：记录"签发"事件，填写新过期日
     - 如需补材料：记录"递交"事件，生成新跟进日

---

## 分类配置

分类信息保存在 `dts_category.conf` 文件中，可以手动编辑。

### 文件位置

```
/dc_html/cp/dts/dts_category.conf
```

### 文件格式

```
大类;小类1,小类2,小类3;
```

### 示例

```
证件;护照,NIE,居留,驾照,公司证照;
车辆;整车保养,轮胎,刹车片,机油/机滤,年检,保险;
健康;体检,洗牙,疫苗;
```

### 修改分类

1. 用文本编辑器打开 `dts_category.conf`
2. 按照格式添加或修改分类
3. 保存文件
4. 刷新浏览器即可生效

---

## 规则管理

### 查看规则

进入"规则管理"页面，可以查看所有预设规则模板。

### 规则字段说明

- **规则名称**：规则的描述性名称
- **规则类型**：expiry_based（过期日）、last_done_based（周期）、submit_based（跟进）
- **适用分类**：规则适用的大类和小类
- **参数**：
  - 最早可办偏移：负数表示提前天数
  - 周期间隔：天数或月数
  - 里程间隔：建议更换里程（仅供参考）
  - 跟进偏移：递交后多少天/月跟进

### 修改规则

规则模板存储在数据库的 `cp_dts_rule` 表中。如需修改，可以：

1. 直接在数据库中修改
2. 或联系管理员

---

## 数据库结构

### 核心表

1. **cp_dts_subject**：主体表
2. **cp_dts_object**：对象表
3. **cp_dts_rule**：规则模板表
4. **cp_dts_event**：事件表
5. **cp_dts_object_state**：对象当前状态表（性能优化）

### 表关系

```
cp_dts_subject (主体)
  ↓
cp_dts_object (对象)
  ↓
cp_dts_event (事件) → cp_dts_rule (规则)
  ↓
cp_dts_object_state (当前状态)
```

---

## 文件结构

```
/app/cp/dts/
├── dts_schema.sql          # 数据库表结构
├── dts_lib.php             # 通用函数库
├── dts_category.conf       # 分类配置文件
├── dts_readme.md           # 使用文档
├── views/                  # 视图文件
│   ├── dts_main.php        # DTS 总览
│   ├── dts_subject.php     # 主体管理
│   ├── dts_object.php      # 对象列表
│   ├── dts_object_form.php # 对象表单
│   ├── dts_object_detail.php # 对象详情（时间线）
│   ├── dts_rule.php        # 规则管理
│   └── dts_event_form.php  # 事件表单
└── actions/                # 动作文件
    ├── dts_subject_save.php
    ├── dts_subject_get_data.php
    ├── dts_object_save.php
    └── dts_event_save.php

/dc_html/cp/dts/
└── dts_style.css           # 样式文件
```

---

## 常见问题

### Q1: 如何添加新的证件类型？

1. 编辑 `dts_category.conf`，在"证件"大类下添加小类
2. （可选）在数据库中添加对应的规则模板

### Q2: 事件保存后没有生成提醒？

检查以下几点：
1. 是否选择了规则模板
2. 是否填写了必要的日期字段（如新过期日）
3. 规则模板是否启用

### Q3: 如何修改时间节点计算规则？

在数据库的 `cp_dts_rule` 表中修改对应规则的偏移参数。

### Q4: 能否批量导入数据？

当前不支持批量导入，可以通过编写脚本直接操作数据库表实现。

---

## 技术说明

### 时间节点计算逻辑

时间节点的计算在 `dts_lib.php` 的 `dts_calculate_nodes()` 函数中实现：

```php
// 证件类：基于过期日计算
if ($rule['rule_type'] === 'expiry_based') {
    $nodes['deadline_date'] = $base_date;
    $nodes['window_start_date'] = $base_date + earliest_offset_days;
    $nodes['suggest_date'] = $base_date + suggest_offset_days;
    $nodes['window_end_date'] = $base_date + safe_last_offset_days;
}

// 周期类：基于上次完成日计算
if ($rule['rule_type'] === 'last_done_based') {
    $nodes['cycle_next_date'] = $base_date + cycle_interval;
    $nodes['next_mileage_suggest'] = current_mileage + mileage_interval;
}

// 跟进类：基于递交日计算
if ($rule['rule_type'] === 'submit_based') {
    $nodes['follow_up_date'] = $base_date + follow_up_offset;
}
```

### 对象状态更新

每次保存事件后，系统会自动调用 `dts_update_object_state()` 函数更新对象的当前状态表，以便快速查询。

---

## 版本历史

### v1.0（2025-11-17）

- 初始版本
- 实现主体、对象、事件、规则管理
- 实现 DTS 总览页面
- 支持证件类、周期类、跟进类规则
- 支持车辆里程记录（仅供参考）

---

## 联系与支持

如有问题或建议，请联系系统管理员。
